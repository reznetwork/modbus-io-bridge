# config_tractor.yaml configuration
# Tractor MTZ 82 Modbus/TCP devices
# MB_IO_1.10001 - Ручник
# MB_IO_1.10002 - !Ремень
# MB_IO_1.10003 - !Двигатель

# MB_IO_2.10000 - тормоз
# МB_IO_2.10002 - левый поворотник
# MB_IO_2.10003 - правый поворотник
# MB_IO_2.10005 - ближний свет
# MB_IO_2.10008 - ближний свет
# MB_IO_2.10009 - Гудок


devices:
  - name: mb_io_1
    host: 172.16.102.4
    port: 502
    unit_id: 1
    timeout: 3.0

  - name: mb_io_2
    host: 172.16.102.5
    port: 502
    unit_id: 1
    timeout: 3.0

  - name: mb_io_3
    host: 172.16.102.8
    port: 502
    unit_id: 1
    timeout: 3.0

# Global settings
settings:
  poll_interval_ms: 100   # how often to read inputs
  log_level: INFO         # DEBUG/INFO/WARNING/ERROR
  connect_retry_s: 3.0    # backoff for reconnect

# Mappings: 1 output per entry, each with one or many inputs
mappings:
  - name: handbrake
    input:
      device: mb_io_1
      address: 1               # read DI 1
      source_type: discrete_input  # or "coil" to read coil
    output:
      device: mb_io_1
      address: 0               # write to coil 0
    invert: false
    debounce_ms: 300
    on_error: hold             # hold | force_off | force_on

  - name: neutral
    input:
      device: mb_io_3
      address: 0
      source_type: discrete_input
    output:
      device: mb_io_1
      address: 1
    invert: false               # logical NOT of the input
    debounce_ms: 300
    on_error: force_off

  # Example of combining multiple inputs with logic
  - name: headlights_logic
    inputs:
      - name: switch_left
        device: mb_io_2
        address: 5
        source_type: discrete_input
      - name: switch_right
        device: mb_io_2
        address: 8
        source_type: discrete_input
    # Turn on output when exactly one of the switches is active
    logic: "switch_left ^ switch_right"
    output:
      device: mb_io_2
      address: 20
    debounce_ms: 100
    on_error: hold

  # Example using implicit names (in1, in2, ...) when no input names are given
  - name: fan_enable_logic
    inputs:
      - device: mb_io_2
        address: 2
        source_type: discrete_input
      - device: mb_io_3
        address: 7
        source_type: discrete_input
    logic: "in1 and not in2"  # in1 -> enable signal, in2 -> interlock
    output:
      device: mb_io_1
      address: 12
    debounce_ms: 200
    on_error: hold

  # Example requiring two inputs ON and one input OFF
  - name: dual_ok_one_blocked
    inputs:
      - name: ok_a
        device: mb_io_1
        address: 4
        source_type: discrete_input
      - name: ok_b
        device: mb_io_1
        address: 5
        source_type: discrete_input
      - name: blocked
        device: mb_io_1
        address: 6
        source_type: discrete_input
    logic: "ok_a and ok_b and not blocked"
    output:
      device: mb_io_2
      address: 11
    debounce_ms: 150
    on_error: force_off
